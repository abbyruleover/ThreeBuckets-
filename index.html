<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Three Bucket Strategy — Mobile</title>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <style>
    :root{--bg:#f8fafc; --panel:#ffffff; --border:#e5e7eb; --muted:#64748b;
      --text:#0f172a; --brand:#0ea5e9; --brand-ink:#0b5ed7;}
    html,body{background:var(--bg);color:var(--text);margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    header{position:sticky;top:0;z-index:10;background:#ffffffcc;backdrop-filter:blur(8px);border-bottom:1px solid var(--border);}
    header .inner{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:12px;}
    .brand{font-weight:800;letter-spacing:.2px;}
    .tabs{margin-left:auto;display:flex;gap:6px;}
    .tab{padding:8px 12px;border-radius:8px;border:1px solid var(--border);cursor:pointer;user-select:none;color:var(--muted);background:var(--panel);}
    .tab.active{background:var(--brand);color:#fff;border-color:var(--brand);}
    main{max-width:1100px;margin:16px auto;padding:0 16px 72px;}
    .row{display:grid;grid-template-columns:1fr;gap:16px;}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;box-shadow:0 1px 0 rgba(2,6,23,.04);margin-bottom:12px;}
    .card h3{margin:0 0 8px 0;}
    .slider-wrap{background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.03);border:1px solid var(--border);border-radius:12px;padding:10px;margin:10px 0;}
    .desc{display:inline-block;font-size:12px;color:var(--muted);background:#f1f5f9;padding:3px 6px;border-radius:6px;margin:6px 0;max-width:100%;}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:#eef2ff;color:var(--brand-ink);font-weight:700;min-width:80px;text-align:center}
    .controls-bar{position:sticky;bottom:0;background:#ffffffee;backdrop-filter:blur(8px);display:flex;align-items:center;gap:12px;flex-wrap:wrap;padding:10px;border:1px solid var(--border);border-radius:12px;margin-top:8px;}
    button{border:1px solid var(--brand);background:var(--brand);color:#fff;border-radius:10px;padding:10px 16px;font-weight:700;box-shadow:0 1px 0 rgba(14,165,233,.2);cursor:pointer;}
    input[type=range]{width:100%}
    label{display:block;margin-bottom:6px}
    .muted{color:var(--muted);font-size:12px}
    .plot{width:100%;height:420px}
    table{width:100%;border-collapse:collapse;background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden;}
    th,td{padding:8px 10px;border-bottom:1px solid var(--border);}
    th{background:#f1f5f9;text-align:left;}
    footer{margin:24px 0;color:var(--muted);font-size:12px;text-align:center;}
    @media (max-width: 600px){
      .plot{height:360px}
    }
  </style>
</head>
<body>
  <header>
    <div class="inner">
      <div class="brand">The Three Bucket Strategy</div>
      <div class="tabs">
        <div id="tabDash" class="tab active">Dashboard</div>
        <div id="tabAbout" class="tab">About</div>
      </div>
    </div>
  </header>

  <main>
    <div id="panelDash">
      <div class="row">

        <div class="card">
          <h3>P1 — Cash buffer</h3>
          <div class="slider-wrap">
            <label for="baseSpend">Starting withdrawal (annual)</label>
            <span class="desc">P1 starts equal to this. Used in down years or to cover shortfalls in up years. Grows annually by inflation until capped.</span>
            <input type="range" id="baseSpend" min="60000" max="500000" step="1000" value="250000" />
            <div style="display:flex;justify-content:space-between;align-items:center">
              <small class="muted">Current</small>
              <span id="baseSpendLabel" class="pill">$250,000</span>
            </div>
          </div>
          <div class="slider-wrap">
            <label for="infl">Withdrawal inflation (%)</label>
            <span class="desc">Year‑over‑year increase applied to spending (e.g., 7%); capped below.</span>
            <input type="range" id="infl" min="0" max="10" step="0.1" value="7" />
            <div style="text-align:right"><span id="inflLabel" class="pill">7.0%</span></div>
          </div>
          <div class="slider-wrap">
            <label for="cap">Withdrawal cap (annual)</label>
            <span class="desc">Maximum annual withdrawal after inflation adjustments.</span>
            <input type="range" id="cap" min="200000" max="600000" step="10000" value="400000" />
            <div style="text-align:right"><span id="capLabel" class="pill">$400,000</span></div>
          </div>
          <div class="slider-wrap">
            <label><input type="checkbox" id="quarterlyMode" /> Use quarterly withdrawals (needs shiller_monthly.csv)</label>
            <span class="desc">If on, withdrawals occur once per year in the chosen quarter using Shiller monthly data; rules apply to year‑to‑date returns at that quarter.</span>
            <div style="margin-top:8px;">
              <label for="withdrawQuarter">Withdrawal quarter</label>
              <select id="withdrawQuarter" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:10px;">
                <option value="Q1">Q1 (Mar)</option>
                <option value="Q2">Q2 (Jun)</option>
                <option value="Q3">Q3 (Sep)</option>
                <option value="Q4" selected>Q4 (Dec)</option>
              </select>
            </div>
          </div>

          <div class="slider-wrap">
            <label for="withdrawStartYear">Begin withdrawals in</label>
            <span class="desc">Default Year 3. Year 1 means immediate withdrawals.</span>
            <input type="range" id="withdrawStartYear" min="1" max="10" step="1" value="3" />
            <div style="text-align:right"><span id="withdrawStartYearLabel" class="pill">Year 3</span></div>
          </div>
        </div>

        <div class="card">
          <h3>P2 — Core (market‑linked)</h3>
          <div class="slider-wrap">
            <label for="p2Start">P2 starting balance</label>
            <span class="desc">Main portfolio invested in broad market. Pays withdrawals in non‑negative years first.</span>
            <input type="range" id="p2Start" min="1000000" max="6000000" step="50000" value="3000000" />
            <div style="text-align:right"><span id="p2StartLabel" class="pill">$3,000,000</span></div>
          </div>
        </div>

        <div class="card">
          <h3>P3 — Long‑term growth</h3>
          <div class="slider-wrap">
            <label for="p3Start">P3 starting balance</label>
            <span class="desc">Left untouched unless P2 is depleted. Compounds at P2 path + 2pp annually. Also receives optional contributions.</span>
            <input type="range" id="p3Start" min="0" max="5000000" step="50000" value="1000000" />
            <div style="text-align:right"><span id="p3StartLabel" class="pill">$1,000,000</span></div>
          </div>
        </div>

        <div class="card">
          <h3>Options</h3>
          <div class="slider-wrap">
            <label><input type="checkbox" id="optEnable" checked /> Enable optional features</label>
            <span class="desc">Toggle extra features below. When off, contributions and lump withdrawals are disabled.</span>
          </div>

          <div class="slider-wrap opt">
            <label><input type="checkbox" id="p3ContribOn" checked /> Enable P3 contributions</label>
            <span class="desc">Contribute to P3 during early years to build long‑term cushion.</span>
            <div style="display:grid;grid-template-columns:1fr;gap:8px;margin-top:8px;">
              <div>
                <label for="p3ContribAmt">Annual contribution to P3</label>
                <input type="range" id="p3ContribAmt" min="0" max="500000" step="5000" value="180000" />
                <div style="text-align:right"><span id="p3ContribAmtLabel" class="pill">$180,000</span></div>
              </div>
              <div>
                <label for="p3ContribYears">Years to contribute</label>
                <input type="range" id="p3ContribYears" min="0" max="20" step="1" value="10" />
                <div style="text-align:right"><span id="p3ContribYearsLabel" class="pill">10 years</span></div>
              </div>
            </div>
          </div>

          <div class="slider-wrap opt">
            <label><input type="checkbox" id="lumpsOn" /> Enable extra withdrawals (from P2)</label>
            <span class="desc">Take scheduled extra withdrawals from P2 (e.g., one every 5 years).</span>
            <div style="display:grid;grid-template-columns:1fr;gap:8px;margin-top:8px;">
              <div>
                <label for="lumpAmt">Amount per extra withdrawal</label>
                <input type="range" id="lumpAmt" min="50000" max="1000000" step="5000" value="300000" />
                <div style="text-align:right"><span id="lumpAmtLabel" class="pill">$300,000</span></div>
              </div>
              <div>
                <label for="lumpEvery">Every N years</label>
                <input type="range" id="lumpEvery" min="2" max="10" step="1" value="5" />
                <div style="text-align:right"><span id="lumpEveryLabel" class="pill">every 5 yrs</span></div>
              </div>
              <div>
                <label for="lumpStart">Start calendar year</label>
                <input type="range" id="lumpStart" min="2025" max="2064" step="1" value="2029" />
                <div style="text-align:right"><span id="lumpStartLabel" class="pill">2029</span></div>
              </div>
            </div>
          </div>
        </div>

        <div class="controls-bar" id="simulateBar">
          <span class="muted">Adjust settings, then tap Simulate.</span>
          <button id="simulateBtn">Simulate</button>
          <span class="muted" style="margin-left:10px;">Source: <span id="sourceLabel">Annual S&P 500 (embedded)</span></span>
        </div>

        <div class="card">
          <h3>Worst‑5 P2 trajectories (40‑year horizon)</h3>
          <div id="plotWorst5" class="plot"></div>
        </div>

        <div class="card">
          <h3>Browse any single window</h3>
          <div class="slider-wrap">
            <label for="browseWindow">Select start year (1935–1985)</label>
            <span class="desc">View the P2 start‑of‑year balance for one 40‑year window.</span>
            <input type="range" id="browseWindow" min="1935" max="1985" step="1" value="1935" />
            <div style="text-align:right"><span id="browseWindowLabel" class="pill">1935–1974</span></div>
          </div>
          <div id="plotSingle" class="plot"></div>
        </div>

        <div class="card">
          <h3>Metrics</h3>
          <table>
            <tbody id="metricsTable"></tbody>
          </table>
        </div>

      </div>
      <footer>Created by Abhay &amp; Sankrit</footer>
    </div>

    <div id="panelAbout" style="display:none">
      <div class="card" style="text-align:center;"><img alt="Three‑Bucket visual" style="max-width:100%;height:auto;border:1px solid var(--border);border-radius:10px;" src=<div class="card">
        <h3>The Strategy</h3>
        <p>The Three Bucket Strategy separates your retirement funds by purpose and time horizon:</p>
        <ul>
          <li><strong>P1 (Cash)</strong> — immediate liquidity for spending; used in down years or to cover shortfalls. Target equals the current annual withdrawal need.</li>
          <li><strong>P2 (Core)</strong> — market‑linked portfolio that funds spending in non‑negative years and tops up P1 in the next non‑negative year after P1 was used.</li>
          <li><strong>P3 (Growth)</strong> — long‑term compounding; only tapped to refill P2 toward its initial level if P2 is depleted.</li>
        </ul>
        <p><em>Why this helps:</em> P1 smooths sequence risk; P2 keeps most capital invested; P3 preserves long‑run growth and serves as a backstop.</p>
      </div>
      <div class="card">
        <h3>Assumptions & Mechanics</h3>
        <ul>
          <li>Horizon: 40 years from 2025 onward; simulated with rolling annual S&amp;P 500 paths (1935–2024).</li>
          <li>Withdrawals: start in Year 3 by default; grow by the inflation slider and stop growing once the cap is reached.</li>
          <li>Down years: withdraw from P1 first; any shortfall then P2, then P3.</li>
          <li>Up years: withdraw from P2 first; if short, tap P1 for the remainder (then refill P1 next non‑negative year).</li>
          <li>P1 top‑up: in the next non‑negative year after P1 was used, P2 tops P1 up to that year’s withdrawal target.</li>
          <li>P2→P3: if P2 hits 0, P3 replenishes P2 toward its initial starting balance (subject to P3 funds).</li>
          <li>P3 growth: compounds at the same annual path as P2 plus 2 percentage points; optional early contributions.</li>
          <li>Optional features: scheduled extra withdrawals from P2; early‑year contributions to P3.</li>
        </ul>
      </div>
      <footer>Created by Abhay &amp; Sankrit</footer>
    </div>
  </main>

<script>
const START_FUTURE = 2025;
const HORIZON = 40;
const YEARS = Array.from({length: HORIZON}, (_,i)=>START_FUTURE+i);
const SP500 = {"1935": 47.67, "1936": 33.92, "1937": -35.03, "1938": 31.12, "1939": -0.41, "1940": -9.78, "1941": -11.59, "1942": 20.34, "1943": 25.9, "1944": 19.75, "1945": 36.44, "1946": -8.07, "1947": 5.71, "1948": 5.5, "1949": 18.79, "1950": 31.71, "1951": 24.02, "1952": 18.37, "1953": -0.99, "1954": 52.62, "1955": 31.56, "1956": 6.56, "1957": -10.78, "1958": 43.36, "1959": 11.96, "1960": 0.47, "1961": 26.89, "1962": -8.73, "1963": 22.8, "1964": 16.48, "1965": 12.45, "1966": -10.06, "1967": 23.98, "1968": 11.06, "1969": -8.5, "1970": 4.01, "1971": 14.31, "1972": 18.98, "1973": -14.66, "1974": -26.47, "1975": 37.2, "1976": 23.84, "1977": -7.18, "1978": 6.56, "1979": 18.44, "1980": 32.42, "1981": -4.91, "1982": 21.55, "1983": 22.56, "1984": 6.27, "1985": 31.73, "1986": 18.67, "1987": 5.25, "1988": 16.61, "1989": 31.69, "1990": -3.1, "1991": 30.47, "1992": 7.62, "1993": 10.08, "1994": 1.32, "1995": 37.58, "1996": 22.96, "1997": 33.36, "1998": 28.58, "1999": 21.04, "2000": -9.1, "2001": -11.89, "2002": -22.1, "2003": 28.68, "2004": 10.88, "2005": 4.91, "2006": 15.79, "2007": 5.49, "2008": -37.0, "2009": 26.46, "2010": 15.06, "2011": 2.11, "2012": 16.0, "2013": 32.39, "2014": 13.69, "2015": 1.38, "2016": 11.96, "2017": 21.83, "2018": -4.38, "2019": 31.49, "2020": 18.4, "2021": 28.71, "2022": -18.11, "2023": 26.29, "2024": 25.02};

// ===== Shiller monthly loader (optional) =====
let SHILLER = null; // map: {YYYY: [m1Factor, ..., m12Factor]}

async function tryLoadShiller(){
  try{
    const resp = await fetch('shiller_monthly.csv', {cache:'no-store'});
    if (!resp.ok) throw new Error('HTTP '+resp.status);
    const text = await resp.text();
    const lines = text.trim().split(/?
/);
    const header = lines.shift().split(',').map(h=>h.trim().toLowerCase());
    const yi = header.findIndex(h=>h==='year');
    const mi = header.findIndex(h=>h==='month');
    // accept returnpct / monthly_return / return
    let ri = header.findIndex(h=>h==='returnpct');
    if (ri<0) ri = header.findIndex(h=>h==='monthly_return');
    if (ri<0) ri = header.findIndex(h=>h==='return');
    if (yi<0 || mi<0 || ri<0) throw new Error('Need Year, Month, ReturnPct (or monthly_return/return)');
    const byYear = {};
    for (const line of lines){
      if (!line.trim()) continue;
      const c = line.split(',').map(s=>s.trim());
      const y = parseInt(c[yi],10);
      const m = parseInt(c[mi],10);
      let r = parseFloat(c[ri]); if (isNaN(r)) continue;
      // If in percents (e.g., 7.21 meaning 7.21%), normalize to decimal.
      if (Math.abs(r) > 1.5) r = r/100.0;
      const f = 1 + r;
      if (!byYear[y]) byYear[y] = new Array(12).fill(1.0);
      if (m>=1 && m<=12) byYear[y][m-1] = f;
    }
    if (!Object.keys(byYear).length) throw new Error('No monthly rows parsed');
    window.SHILLER = byYear;
    const label = document.getElementById('sourceLabel');
    if (label) label.textContent = 'Shiller monthly (quarterly mode available)';
    const qm = document.getElementById('quarterlyMode');
    if (qm) qm.disabled = false;
  }catch(e){
    window.SHILLER = null;
    const label = document.getElementById('sourceLabel');
    if (label) label.textContent = 'Annual S&P 500 (embedded)';
    const qm = document.getElementById('quarterlyMode');
    if (qm){ qm.checked=false; qm.disabled=true; }
  }
}
document.addEventListener('DOMContentLoaded', tryLoadShiller);


function quarterEndMonth(q){ return q==='Q1'?3 : q==='Q2'?6 : q==='Q3'?9 : 12; }

function simulateWindowQuarterly(windowStart, params){
  const p2Start = params.p2Start, p3Start = params.p3Start, baseSpend=params.baseSpend,
        infl=params.infl, cap=params.cap, withdrawDelay=params.withdrawDelay,
        optEnable=params.optEnable, p3ContribOn=params.p3ContribOn, contribAmt=params.p3ContribAmt,
        contribYears=params.p3ContribYears, lumpsOn=params.lumpsOn, lumpAmt=params.lumpAmt,
        lumpEvery=params.lumpEvery, lumpStart=params.lumpStart, q=params.withdrawQuarter;
  let p2 = p2Start, p3 = p3Start, p1 = baseSpend;
  let p1Needs=false; const p1ReplYears=[]; const p2ReplYears=[];
  const p2SOY=[]; const p1EOY=[]; let p2Min=p2;
  for(let i=1;i<=HORIZON;i++){
    const yr = START_FUTURE + (i-1);
    const srcYear = windowStart + (i-1);
    const months = SHILLER && SHILLER[srcYear];
    const endm = months ? quarterEndMonth(q) : 12;
    const preQ = months ? months.slice(0,endm).reduce((a,f)=>a*f,1.0) : 1.0 + (SP500[srcYear]||0)/100.0;
    const postQ = months ? months.slice(endm).reduce((a,f)=>a*f,1.0) : 1.0;
    p2SOY.push(p2);
    if (optEnable && p3ContribOn && i<=contribYears) p3 += contribAmt;
    // growth to quarter
    p2 *= preQ; p3 *= preQ * 1.02; // approx +2pp
    const S = spendAmount(i, baseSpend, infl, cap, withdrawDelay);
    const p1Target = S;
    const ytdR = preQ - 1.0;
    if (ytdR >= 0 && p1Needs && p1 < p1Target) {
      const top = Math.min(p1Target - p1, p2);
      if (top > 0) { p2 -= top; p1 += top; p1ReplYears.push(yr); }
      p1Needs = (p1 < p1Target);
    }
    if (S>0){
      if (ytdR < 0){
        const useP1 = Math.min(S, p1); p1 -= useP1;
        let short = S - useP1;
        if (short > 0) { const t = Math.min(short, p2); p2 -= t; short -= t; }
        if (short > 0) { const t = Math.min(short, p3); p3 -= t; short -= t; }
        if (p1 < p1Target) p1Needs = true;
      }else{
        const useP2 = Math.min(S, p2); p2 -= useP2;
        let short = S - useP2;
        if (short > 0 && p1 > 0) { const t = Math.min(short, p1); p1 -= t; short -= t; p1Needs = true; }
        if (short > 0) { const t = Math.min(short, p3); p3 -= t; short -= t; }
      }
    }
    // remaining growth
    p2 *= postQ; p3 *= postQ * 1.02;
    if (optEnable && lumpsOn && yr>=lumpStart && ((yr-lumpStart)%lumpEvery===0)){
      if (p2 >= lumpAmt) { p2 -= lumpAmt; }
      else { let rem = lumpAmt - p2; p2 = 0; const take = Math.min(rem, p3); p3 -= take; }
    }
    if (p2 <= 0) {
      const need = p2Start - p2;
      const xfer = Math.min(need, p3);
      if (xfer > 0) { p3 -= xfer; p2 += xfer; p2ReplYears.push(yr); }
    }
    p1EOY.push(p1);
    p2Min = Math.min(p2Min, p2);
  }
  return {
    summary: { window: windowStart + '–' + (windowStart+HORIZON-1),
      P1_Repl_Count: p1ReplYears.length, P2_Repl_Count: p2ReplYears.length,
      P2_Min: p2Min, P2_End: p2, P3_End: p3 },
    trace: { Year: YEARS, P2_SOY: p2SOY, P1_EOY: p1EOY }
  };
}

const WINDOW_STARTS = Array.from({length: 51}, (_,i)=>1935+i);

// Tabs
document.addEventListener('DOMContentLoaded', function(){
  const tabDash = document.getElementById('tabDash');
  const tabAbout = document.getElementById('tabAbout');
  const panelDash = document.getElementById('panelDash');
  const panelAbout = document.getElementById('panelAbout');
  function showDash(){ panelDash.style.display='block'; panelAbout.style.display='none'; tabDash.classList.add('active'); tabAbout.classList.remove('active'); }
  function showAbout(){ panelDash.style.display='none'; panelAbout.style.display='block'; tabAbout.classList.add('active'); tabDash.classList.remove('active'); }
  tabDash.addEventListener('click', showDash);
  tabAbout.addEventListener('click', showAbout);
  showDash();
});

function fmtMoney(x){return x.toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0});}
function setLabel(id, val){const el=document.getElementById(id+'Label'); if(el) el.textContent=val;}

// Option toggle disables/enables inner controls
function applyOptionToggle(){
  const on = document.getElementById('optEnable').checked;
  // disable feature toggles and ranges when master off
  document.getElementById('p3ContribOn').disabled = !on;
  document.getElementById('lumpsOn').disabled = !on;
  document.querySelectorAll('.opt input[type=range]').forEach(el=>{ el.disabled = !on; });
}
document.addEventListener('DOMContentLoaded', ()=>{
  const opt = document.getElementById('optEnable');
  if (opt) { opt.addEventListener('change', applyOptionToggle); applyOptionToggle(); }
});

function updateLabels(){
  try{ setLabel('withdrawStartYear', 'Year ' + parseInt(document.getElementById('withdrawStartYear').value)); }catch(e){}
  const usd = (id)=> fmtMoney(parseFloat(document.getElementById(id).value));
  setLabel('p2Start', usd('p2Start'));
  setLabel('p3Start', usd('p3Start'));
  setLabel('baseSpend', usd('baseSpend'));
  setLabel('p3ContribAmt', usd('p3ContribAmt'));
  setLabel('p3ContribYears', parseInt(document.getElementById('p3ContribYears').value)+' years');
  setLabel('infl', parseFloat(document.getElementById('infl').value).toFixed(1)+'%');
  setLabel('cap', usd('cap'));
  setLabel('lumpAmt', usd('lumpAmt'));
  setLabel('lumpEvery', 'every '+parseInt(document.getElementById('lumpEvery').value)+' yrs');
  setLabel('lumpStart', document.getElementById('lumpStart').value);
  const ws = parseInt(document.getElementById('browseWindow').value);
  setLabel('browseWindow', ws+'–'+(ws+39));
}
['p2Start','p3Start','baseSpend','infl','cap','p3ContribOn','p3ContribAmt','p3ContribYears','lumpsOn','lumpAmt','lumpEvery','lumpStart','withdrawStartYear','browseWindow','optEnable']
  .forEach(id=>{ const el=document.getElementById(id); if(!el) return; el.addEventListener('input',updateLabels); el.addEventListener('change',updateLabels); });
document.addEventListener('DOMContentLoaded', updateLabels);

function spendAmount(i, baseSpend, infl, cap, withdrawDelay){
  if (i < withdrawDelay) return 0.0;
  const yearsSinceStart = i - withdrawDelay;
  const amt = baseSpend * Math.pow(1+infl, yearsSinceStart);
  return Math.min(cap, amt);
}

function simulateWindow(windowStart, p2Start, p3Start, baseSpend=250000.0, infl=0.07, cap=400000.0,
                        optEnable=true, p3ContribOn=true, contribAmt=180000.0, contribYears=10,
                        lumpsOn=false, lumpAmt=0.0, lumpEvery=5, lumpStart=2029,
                        withdrawDelay=3) {
  const rSeq = Array.from({length: HORIZON}, (_,i)=> SP500[windowStart+i]/100.0);
  const rP3 = rSeq.map(r => r + 0.02);

  let p2 = p2Start;
  let p3 = p3Start;
  let p1 = baseSpend;

  let p1Needs = false;
  const p1ReplYears = [];
  const p2ReplYears = [];

  const p2SOY = [];
  const p1EOY = [];

  let p2Min = p2;

  for (let i=1; i<=HORIZON; i++) {
    const yr = START_FUTURE + (i-1);
    const r = rSeq[i-1];
    const rp3 = rP3[i-1];

    p2SOY.push(p2);

    // contributions first
    if (optEnable && p3ContribOn && i <= contribYears) p3 += contribAmt;
    // growth
    p3 *= (1+rp3);
    p2 *= (1+r);

    const S = spendAmount(i, baseSpend, infl, cap, withdrawDelay);
    const p1Target = S;

    // top-up P1 only if it was needed last year and this year is non-negative
    if (r >= 0 && p1Needs && p1 < p1Target) {
      const top = Math.min(p1Target - p1, p2);
      if (top > 0) { p2 -= top; p1 += top; p1ReplYears.push(yr); }
      p1Needs = (p1 < p1Target);
    }

    if (S > 0) {
      if (r < 0) {
        const useP1 = Math.min(S, p1); p1 -= useP1;
        let short = S - useP1;
        if (short > 0) { const t = Math.min(short, p2); p2 -= t; short -= t; }
        if (short > 0) { const t = Math.min(short, p3); p3 -= t; short -= t; }
        if (p1 < p1Target) p1Needs = true;
      } else {
        const useP2 = Math.min(S, p2); p2 -= useP2;
        let short = S - useP2;
        if (short > 0 && p1 > 0) { const t = Math.min(short, p1); p1 -= t; short -= t; p1Needs = true; }
        if (short > 0) { const t = Math.min(short, p3); p3 -= t; short -= t; }
      }
    }

    if (optEnable && lumpsOn && yr >= lumpStart && ((yr - lumpStart) % lumpEvery === 0)) {
      if (p2 >= lumpAmt) {
        p2 -= lumpAmt;
      } else {
        let rem = lumpAmt - p2; p2 = 0.0;
        const take = Math.min(rem, p3); p3 -= take; rem -= take;
      }
    }

    if (p2 <= 0) {
      const need = p2Start - p2;
      const xfer = Math.min(need, p3);
      if (xfer > 0) { p3 -= xfer; p2 += xfer; p2ReplYears.push(yr); }
    }

    p1EOY.push(p1);
    p2Min = Math.min(p2Min, p2);
  }

  return {
    summary: {
      window: windowStart + '–' + (windowStart+HORIZON-1),
      P1_Repl_Count: p1ReplYears.length,
      P2_Repl_Count: p2ReplYears.length,
      P2_Min: p2Min,
      P2_End: p2,
      P3_End: p3
    },
    trace: { Year: YEARS, P2_SOY: p2SOY, P1_EOY: p1EOY }
  };
}

function runBatch(params) {
  const summaries = [];
  const traces = {};
  for (const ws of WINDOW_STARTS) {
    const res = simulateWindow(
      ws, params.p2Start, params.p3Start, params.baseSpend,
      params.infl, params.cap,
      params.optEnable, params.p3ContribOn, params.p3ContribAmt, params.p3ContribYears,
      params.lumpsOn, params.lumpAmt, params.lumpEvery, params.lumpStart,
      params.withdrawDelay
    );
    summaries.push(res.summary);
    traces[ws] = res.trace;
  }
  return {summaries, traces, withdrawQuarter: document.getElementById('withdrawQuarter').value, quarterlyMode: document.getElementById('quarterlyMode').checked};
}

function renderMetrics(summaries) {
  const totalP1 = summaries.reduce((a,s)=>a+s.P1_Repl_Count,0);
  const totalP2 = summaries.reduce((a,s)=>a+s.P2_Repl_Count,0);
  const bestP2 = summaries.reduce((a,s)=> s.P2_End>a.P2_End ? s : a, summaries[0]);
  const worstP2 = summaries.reduce((a,s)=> s.P2_End<a.P2_End ? s : a, summaries[0]);
  const bestP3 = summaries.reduce((a,s)=> s.P3_End>a.P3_End ? s : a, summaries[0]);
  const worstP3 = summaries.reduce((a,s)=> s.P3_End<a.P3_End ? s : a, summaries[0]);

  const rows = [
    ["Total P1 replenishments", totalP1.toLocaleString()],
    ["Total P2 replenishments", totalP2.toLocaleString()],
    ["Best terminal P2 (window)", fmtMoney(bestP2.P2_End) + " — " + bestP2.window],
    ["Worst terminal P2 (window)", fmtMoney(worstP2.P2_End) + " — " + worstP2.window],
    ["Best terminal P3 (window)", fmtMoney(bestP3.P3_End) + " — " + bestP3.window],
    ["Worst terminal P3 (window)", fmtMoney(worstP3.P3_End) + " — " + worstP3.window]
  ];

  const tbl = document.getElementById("metricsTable");
  tbl.innerHTML = rows.map(r => "<tr><td class='metric'>" + r[0] + "</td><td>" + r[1] + "</td></tr>").join("");
}

function renderWorst5(summaries, traces) {
  const sorted = summaries.slice().sort((a,b)=>a.P2_End-b.P2_End).slice(0,5);
  const palette = ["#1f77b4","#2ca02c","#ff7f0e","#9467bd","#8c564b"];
  const data = sorted.map((s,i)=> ({
    x: traces[parseInt(s.window.slice(0,4))].Year,
    y: traces[parseInt(s.window.slice(0,4))].P2_SOY,
    type: "scatter",
    mode: "lines",
    name: s.window,
    line: { width: 2.5, color: palette[i % palette.length] }
  }));
  const layout = {
    xaxis: { title: {text:"Year", standoff: 28}, automargin: true },
    yaxis: { title: {text:"P2 balance", standoff: 28}, tickprefix: "$", separatethousands: true, automargin: true },
    legend: { orientation: "h", yanchor: "bottom", y: 1.02, xanchor: "left", x: 0 },
    margin: { l: 70, r: 20, t: 10, b: 60 }
  };
  Plotly.newPlot("plotWorst5", data, layout, {responsive: true}).then(()=>reflowLegendMobile('plotWorst5'));
}

function renderSingle(ws, traces) {
  const tr = traces[ws];
  const data = [{
    x: tr.Year,
    y: tr.P2_SOY,
    type: "scatter",
    mode: "lines",
    name: ws + "–" + (ws+39),
    line: { width: 3 }
  }];
  const layout = {
    xaxis: { title: {text:"Year", standoff: 28}, automargin: true },
    yaxis: { title: {text:"P2 balance", standoff: 28}, tickprefix: "$", separatethousands: true, automargin: true },
    showlegend: false,
    margin: { l: 70, r: 20, t: 10, b: 60 }
  };
  Plotly.newPlot("plotSingle", data, layout, {responsive: true});
}

// Mobile legend positioning helper
function reflowLegendMobile(divId){
  try{
    const w = document.getElementById(divId).getBoundingClientRect().width;
    const layout = (w < 640)
      ? {legend: {orientation: "h", yanchor: "top", y: -0.2, xanchor: "left", x: 0}}
      : {legend: {orientation: "h", yanchor: "bottom", y: 1.02, xanchor: "left", x: 0}};
    Plotly.relayout(divId, layout);
  }catch(e){}
}
window.addEventListener('resize', ()=> reflowLegendMobile('plotWorst5'));

function readParams() {
  const p2Start = parseFloat(document.getElementById("p2Start").value);
  const p3Start = parseFloat(document.getElementById("p3Start").value);
  const baseSpend = parseFloat(document.getElementById("baseSpend").value);
  const infl = parseFloat(document.getElementById("infl").value)/100.0;
  const cap = parseFloat(document.getElementById("cap").value);
  const optEnable = document.getElementById("optEnable").checked;
  const p3ContribOn = document.getElementById("p3ContribOn").checked;
  const p3ContribAmt = parseFloat(document.getElementById("p3ContribAmt").value);
  const p3ContribYears = parseInt(document.getElementById("p3ContribYears").value);
  const lumpsOn = document.getElementById("lumpsOn").checked;
  const lumpAmt = parseFloat(document.getElementById("lumpAmt").value);
  const lumpEvery = parseInt(document.getElementById("lumpEvery").value);
  const lumpStart = parseInt(document.getElementById("lumpStart").value);
  const withdrawDelay = parseInt(document.getElementById("withdrawStartYear").value);
  return {p2Start, p3Start, baseSpend, infl, cap, optEnable, p3ContribOn, p3ContribAmt, p3ContribYears, lumpsOn, lumpAmt, lumpEvery, lumpStart, withdrawDelay};
}

let lastTraces = null;
function simulate(){
  const btn = document.getElementById("simulateBtn");
  btn.disabled = true; btn.textContent = "Simulating…";
  try {
    updateLabels();
    const params = readParams();
    const res = (params.quarterlyMode && SHILLER) ? (function(){ const out={summaries:[], traces:{}}; for(const ws of WINDOW_STARTS){ const r=simulateWindowQuarterly(ws, params); out.summaries.push(r.summary); out.traces[ws]=r.trace; } return out; })() : runBatch(params);
    lastTraces = res.traces;
    renderMetrics(res.summaries);
    renderWorst5(res.summaries, res.traces);
    const ws = parseInt(document.getElementById('browseWindow').value);
    renderSingle(ws, res.traces);
  } finally {
    btn.disabled = false; btn.textContent = "Simulate";
  }
}

document.addEventListener("DOMContentLoaded", ()=> {
  document.getElementById("simulateBtn").addEventListener("click", simulate);
  document.getElementById("browseWindow").addEventListener("input", ()=>{
    const ws = parseInt(document.getElementById('browseWindow').value);
    setLabel('browseWindow', ws+'–'+(ws+39));
    if (lastTraces) renderSingle(ws, lastTraces);
  });
  simulate();
});
</script>
</body>
</html>
