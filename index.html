<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>The Three Bucket Strategy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;margin:0;background:#f7f8fb;color:#0f172a}
    .container{max-width:1200px;margin:0 auto;padding:20px 16px 28px}
    .card{background:#fff;border-radius:14px;box-shadow:0 8px 30px rgba(2,8,23,.08);padding:18px 20px;margin:16px 0}
    h1{font-size:22px;font-weight:800;margin:0 0 10px} h2{font-size:18px;font-weight:700;margin:6px 0 14px} h3{font-size:13px;font-weight:800;text-transform:uppercase;color:#475569;letter-spacing:.8px;margin:16px 0 8px}
    .tabs{display:flex;gap:8px;border-bottom:1px solid #e7ecf4;margin-bottom:12px} .tab{padding:10px 14px;border-radius:10px 10px 0 0;background:#e9f2ff;color:#0b5ed7;cursor:pointer;font-weight:700} .tab.active{background:#fff;color:#0f172a;border:1px solid #e7ecf4;border-bottom:0}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px} @media(max-width:900px){.row{grid-template-columns:1fr}}
    .group{border:1px solid #e5e7eb;border-radius:14px;padding:14px;margin:10px 0 14px;background:#fff} .group h3{margin-top:0}
    .slider-wrap{display:grid;grid-template-columns:1fr auto;align-items:center;gap:10px;padding:10px 12px;background:#fafbff;border:1px solid #cbd5e1;border-radius:12px;margin-bottom:8px}
    textarea{width:100%;min-height:120px;border:1px solid #cbd5e1;border-radius:10px;padding:8px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}
    input[type=range],select{width:100%;accent-color:#3b82f6} select{padding:6px;border-radius:8px;border:1px solid #cbd5e1;background:#fff}
    .pill{display:inline-block;padding:3px 10px;border-radius:999px;background:#eef2ff;color:#0b5ed7;font-size:12px;font-weight:700}
    .small{color:#475569;font-size:12px} .metric{font-weight:700}
    table.metrics{width:100%;border-collapse:collapse} table.metrics td{padding:8px 10px;border-bottom:1px solid #eef2f7} table.metrics tr:first-child td{border-top:1px solid #eef2f7}
    .switch{display:flex;align-items:center;gap:8px;margin:8px 0 10px}
    .actions{display:flex;gap:12px;justify-content:flex-end;align-items:center;margin-top:10px}
    button{background:#3b82f6;color:#fff;border:0;border-radius:10px;padding:11px 16px;font-weight:800;letter-spacing:.2px;box-shadow:0 6px 16px rgba(59,130,246,.25)}
    button:disabled{opacity:.6;box-shadow:none}
    .footer{text-align:center;color:#94a3b8;font-size:12px;margin:24px 0 8px}
    .filebox{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type=file]{border:1px solid #cbd5e1;border-radius:8px;padding:6px;background:#fff}
    details summary{cursor:pointer;font-weight:700}
  </style>
</head>
<body>
<div class="container">
  <div class="tabs">
    <div class="tab active" id="tabDash">Dashboard</div>
    <div class="tab" id="tabAbout">About</div>
  </div>

  <div id="panelDash">
    <h1>The Three Bucket Strategy</h1>

    <div class="card">
      <h2>Three‑Bucket Strategy (summary)</h2>
      <p class="small">
        <b>P1 (Cash):</b> one year of spending; used in <i>negative</i> periods based on trailing 4‑quarter return at your withdrawal quarter; topped up from P2 in the next non‑negative period. Optional HYSA interest by month.<br>
        <b>P2 (Core Growth):</b> main withdrawal source in non‑negative periods; if P2 hits $0, refill from P3 toward initial level.<br>
        <b>P3 (Long‑term Growth):</b> optional contributions early; grows at P2 path +2%; only used to refill P2.
      </p>
    </div>

    <div class="card">
      <h2>Controls</h2>
      <div class="row">

        <div class="group">
          <h3>P1 — Cash Buffer</h3>
          <div class="slider-wrap">
            <label for="baseSpend">Starting withdrawal (and P1 starting cash)</label>
            <div>
              <input id="baseSpend" type="range" min="100000" max="600000" step="10000" value="250000">
              <div style="text-align:right"><span id="baseSpendLabel" class="pill">$250,000</span></div>
            </div>
          </div>
          <div class="slider-wrap">
            <label for="startYear">Withdrawal start year</label>
            <div>
              <input id="startYear" type="range" min="1" max="15" step="1" value="1">
              <div style="text-align:right"><span id="startYearLabel" class="pill">Year 1</span></div>
            </div>
          </div>
          <div class="slider-wrap">
            <label for="p1Quarter">Withdrawal quarter</label>
            <div>
              <select id="p1Quarter">
                <option value="1">Q1</option>
                <option value="2">Q2</option>
                <option value="3">Q3</option>
                <option value="4" selected>Q4</option>
              </select>
            </div>
          </div>
          <div class="switch">
            <input type="checkbox" id="p1HysaOn" checked>
            <label for="p1HysaOn">P1 earns HYSA interest</label>
          </div>
          <div class="slider-wrap">
            <label for="p1HysaAPR">HYSA annual rate (APR)</label>
            <div>
              <input id="p1HysaAPR" type="range" min="0" max="10" step="0.1" value="4.5">
              <div style="text-align:right"><span id="p1HysaAPRLabel" class="pill">4.5%</span></div>
            </div>
          </div>
        </div>

        <div class="group">
          <h3>P2 — Core Growth & Withdrawals</h3>
          <div class="slider-wrap">
            <label for="p2Start">P2 starting balance</label>
            <div>
              <input id="p2Start" type="range" min="2000000" max="7000000" step="50000" value="4500000">
              <div style="text-align:right"><span id="p2StartLabel" class="pill">$4,500,000</span></div>
            </div>
          </div>
        </div>

        <div class="group">
          <h3>P3 — Long‑Term Growth / Reserve</h3>
          <div class="slider-wrap">
            <label for="p3Start">P3 starting balance</label>
            <div>
              <input id="p3Start" type="range" min="0" max="5000000" step="50000" value="1000000">
              <div style="text-align:right"><span id="p3StartLabel" class="pill">$1,000,000</span></div>
            </div>
          </div>
          <div class="switch">
            <input type="checkbox" id="p3ContribOn" checked>
            <label for="p3ContribOn">Enable P3 contributions</label>
          </div>
          <div class="slider-wrap">
            <label for="p3ContribAmt">P3 contribution / year</label>
            <div>
              <input id="p3ContribAmt" type="range" min="0" max="300000" step="10000" value="180000">
              <div style="text-align:right"><span id="p3ContribAmtLabel" class="pill">$180,000</span></div>
            </div>
          </div>
          <div class="slider-wrap">
            <label for="p3ContribYears">P3 contribution years</label>
            <div>
              <input id="p3ContribYears" type="range" min="0" max="20" step="1" value="10">
              <div style="text-align:right"><span id="p3ContribYearsLabel" class="pill">10 years</span></div>
            </div>
          </div>
        </div>

        <div class="group">
          <h3>Spending & Extras</h3>
          <div class="slider-wrap">
            <label for="infl">Inflation (withdrawal growth)</label>
            <div>
              <input id="infl" type="range" min="0" max="10" step="0.1" value="7">
              <div style="text-align:right"><span id="inflLabel" class="pill">7.0%</span></div>
            </div>
          </div>
          <div class="slider-wrap">
            <label for="cap">Withdrawal cap</label>
            <div>
              <input id="cap" type="range" min="200000" max="1000000" step="10000" value="400000">
              <div style="text-align:right"><span id="capLabel" class="pill">$400,000</span></div>
            </div>
          </div>
          <div class="switch">
            <input type="checkbox" id="lumpsOn">
            <label for="lumpsOn">Enable periodic lump-sum from P2</label>
          </div>
          <div class="slider-wrap">
            <label for="lumpAmt">Lump amount</label>
            <div>
              <input id="lumpAmt" type="range" min="0" max="1000000" step="25000" value="500000">
              <div style="text-align:right"><span id="lumpAmtLabel" class="pill">$500,000</span></div>
            </div>
          </div>
          <div class="slider-wrap">
            <label for="lumpEvery">Every N years</label>
            <div>
              <input id="lumpEvery" type="range" min="2" max="10" step="1" value="5">
              <div style="text-align:right"><span id="lumpEveryLabel" class="pill">5 years</span></div>
            </div>
          </div>
          <div class="slider-wrap">
            <label for="lumpStart">First lump year</label>
            <div>
              <input id="lumpStart" type="range" min="2025" max="2064" step="1" value="2029">
              <div style="text-align:right"><span id="lumpStartLabel" class="pill">2029</span></div>
            </div>
          </div>
        </div>

        <div class="group">
          <h3>Quarterly Returns (SPY or Shiller Proxy)</h3>
          <div class="switch">
            <input type="checkbox" id="qMode" checked>
            <label for="qMode">Enable quarterly simulation</label>
          </div>

          <div class="switch">
            <input type="checkbox" id="useShiller">
            <label for="useShiller">Use Shiller public‑domain monthly data (proxy)</label>
          </div>

          <details>
            <summary>Embed Shiller monthly CSV (once)</summary>
            <div class="slider-wrap" style="grid-template-columns:1fr;">
              <label>Paste Shiller monthly CSV here and click <b>Embed now</b>. It will be stored in your browser and auto-loaded next time.</label>
              <textarea id="shillerPaste" placeholder="Year,Month,ReturnPct
1871,1,0.8
1871,2,1.1
..."></textarea>
              <div class="filebox">
                <input id="shillerFile" type="file" accept=".csv,text/csv">
                <button id="embedShillerBtn" type="button">Embed now</button>
                <span id="embedStatus" class="small"></span>
              </div>
            </div>
          </details>

          <div class="slider-wrap" style="grid-template-columns:1fr;">
            <label>Or paste SPY quarterly total returns (CSV with columns: year,quarter,return_pct)</label>
            <textarea id="qCsv" placeholder="year,quarter,return_pct
1935,1,5.1
1935,2,2.4
..."></textarea>
            <div class="small">Priority order: site CSV (<code>./shiller_monthly.csv</code>) → embedded Shiller → SPY quarterly box → derived from annuals (post‑1935 only).</div>
          </div>
        </div>

      </div>
      <div class="actions">
        <span class="small">Adjust settings, then tap Simulate.</span>
        <button id="simulateBtn">Simulate</button>
      </div>
      <div class="small">“Negative vs non‑negative” is determined by the <b>trailing 4‑quarter total return</b> at your chosen withdrawal quarter each year.</div>
    </div>

    <div class="card">
      <h2>Metrics (across all available windows)</h2>
      <table class="metrics" id="metricsTable"></table>
    </div>

    <div class="card">
      <h2>Worst 5 P2 trajectories</h2>
      <div id="worst5"></div>
    </div>

    <div class="card">
      <h2>View a single P2 trajectory</h2>
      <div id="oneWindow"></div>
      <div class="slider-wrap" style="margin-top:8px;">
        <label for="windowIdx">Rolling window</label>
        <div>
          <input id="windowIdx" type="range" min="0" max="50" step="1" value="0">
          <div style="text-align:right"><span id="windowIdxLabel" class="pill">unknown</span></div>
        </div>
      </div>
    </div>

  </div>

  <div id="panelAbout" style="display:none;">
    <h1>About this model</h1>
    <div class="card">
      <h2>Method & Assumptions</h2>
      <ul>
        <li>Horizon: 40 years (2025–2064), evaluated across <b>all possible</b> 40‑year windows present in your CSV (e.g., 1871–1910 … 1985–2024).</li>
        <li><b>Quarterly data priority:</b> Site CSV (<code>./shiller_monthly.csv</code>) → embedded Shiller (localStorage) → SPY quarterly CSV → derived from annuals (limited range).</li>
        <li>Shiller monthly series is aggregated to quarters; trailing 4‑quarter return at your withdrawal quarter decides “negative vs non‑negative.”</li>
      </ul>
      <p class="small">Educational tool — not investment, tax, or legal advice.</p>
    </div>
    <div class="footer">© <script>document.write(new Date().getFullYear());</script> • Created by Abhay & Sankrit</div>
  </div>

</div>

<script>
const START_FUTURE = 2025;
const HORIZON_YEARS = 40;
let YEARS = Array.from({length: HORIZON_YEARS}, (_,i)=>START_FUTURE+i);
let WINDOW_STARTS = []; // will be computed dynamically when data known

// Annual S&P total returns (limited coverage). Used only if no Shiller/quarterly provided and start year is within keys.
const SP500_ANNUAL = {1935:47.67,1936:33.92,1937:-35.03,1938:31.12,1939:-0.41,1940:-9.78,1941:-11.59,1942:20.34,1943:25.90,1944:19.75,1945:36.44,1946:-8.07,1947:5.71,1948:5.50,1949:18.79,1950:31.71,1951:24.02,1952:18.37,1953:-0.99,1954:52.62,1955:31.56,1956:6.56,1957:-10.78,1958:43.36,1959:11.96,1960:0.47,1961:26.89,1962:-8.73,1963:22.80,1964:16.48,1965:12.45,1966:-10.06,1967:23.98,1968:11.06,1969:-8.50,1970:4.01,1971:14.31,1972:18.98,1973:-14.66,1974:-26.47,1975:37.20,1976:23.84,1977:-7.18,1978:6.56,1979:18.44,1980:32.42,1981:-4.91,1982:21.55,1983:22.56,1984:6.27,1985:31.73,1986:18.67,1987:5.25,1988:16.61,1989:31.69,1990:-3.10,1991:30.47,1992:7.62,1993:10.08,1994:1.32,1995:37.58,1996:22.96,1997:33.36,1998:28.58,1999:21.04,2000:-9.10,2001:-11.89,2002:-22.10,2003:28.68,2004:10.88,2005:4.91,2006:15.79,2007:5.49,2008:-37.00,2009:26.46,2010:15.06,2011:2.11,2012:16.00,2013:32.39,2014:13.69,2015:1.38,2016:11.96,2017:21.83,2018:-4.38,2019:31.49,2020:18.40,2021:28.71,2022:-18.11,2023:26.29,2024:25.02};

let __CACHE__ = null;
let __SHILLER_MONTHS__ = null;
let __WINDOW_LABELS__ = []; // "YYYY–YYYY" strings aligned with WINDOW_STARTS

function parseShillerMonthlyCSV(text) {
  const rows = text.split(/\r?\n/).map(s=>s.trim()).filter(s=>s);
  if (rows.length===0) return null;
  const cols = rows[0].split(",").map(s=>s.trim().toLowerCase());
  let idxYear=-1, idxMonth=-1, idxRet=-1, idxDate=-1;
  cols.forEach((c,i)=>{
    if (c==='year') idxYear=i;
    if (c==='month' || c==='mon') idxMonth=i;
    if (c==='returnpct' || c==='ret' || c==='totalreturnpct' || c==='tr') idxRet=i;
    if (c==='date') idxDate=i;
  });
  if (idxDate>-1 && idxRet>-1) {
    const out = [];
    for (let i=1;i<rows.length;i++) {
      const parts = rows[i].split(",");
      if (parts.length<=Math.max(idxDate,idxRet)) continue;
      const date = parts[idxDate].trim();
      const rpct = parseFloat(parts[idxRet]);
      if (!isFinite(rpct)) continue;
      const m = /(\d{4})[-\/]?(\d{1,2})/.exec(date);
      if (!m) continue;
      out.push({year:parseInt(m[1]), month:parseInt(m[2]), r: rpct/100.0});
    }
    return out;
  } else if (idxYear>-1 && idxMonth>-1 && idxRet>-1) {
    const out = [];
    for (let i=1;i<rows.length;i++) {
      const parts = rows[i].split(",");
      if (parts.length<=Math.max(idxYear,idxMonth,idxRet)) continue;
      const Y = parseInt(parts[idxYear]); const M = parseInt(parts[idxMonth]); const rp = parseFloat(parts[idxRet]);
      if (!isFinite(Y) || !isFinite(M) || !isFinite(rp)) continue;
      out.push({year:Y, month:M, r: rp/100.0});
    }
    return out;
  } else {
    return null;
  }
}

function monthsToQuarterlies(ms, startYear) {
  const qs = [];
  for (let y=0; y<HORIZON_YEARS; y++) {
    const yr = startYear + y;
    for (let q=1; q<=4; q++) {
      const months = (q===1?[1,2,3]: q===2?[4,5,6]: q===3?[7,8,9]: [10,11,12]);
      let prod = 1.0, count=0;
      for (const m of months) {
        const row = ms.find(o => o.year===yr && o.month===m);
        if (!row) { prod = null; break; }
        prod *= (1+row.r); count++;
      }
      if (prod===null || count!==3) return null;
      qs.push(prod - 1);
    }
  }
  return qs;
}

function deriveQuarterlyFromAnnual(startYear) {
  if (!(startYear in SP500_ANNUAL)) return null;
  const qs = [];
  for (let y=0; y<HORIZON_YEARS; y++) {
    const ann = SP500_ANNUAL[startYear+y];
    if (ann === undefined) return null;
    const q = Math.pow(1+ann/100, 1/4) - 1;
    for (let k=0; k<4; k++) qs.push(q);
  }
  return qs;
}

function trailing4QReturn(qReturns, idx) {
  let prod = 1.0;
  for (let k = Math.max(0, idx-3); k<=idx; k++) prod *= (1 + qReturns[k]);
  return prod - 1;
}

function annualSpend(yearIndex, baseSpend, infl, cap, startIdx) {
  if (yearIndex < startIdx) return 0;
  const amt = baseSpend * Math.pow(1+infl, yearIndex - startIdx);
  return Math.min(cap, amt);
}

function simulateWindowQuarterly(startYear, params, qR_input) {
  let qR = qR_input;
  if (!qR) {
    // fallback from annuals if possible
    qR = deriveQuarterlyFromAnnual(startYear);
    if (!qR) return null;
  }

  const qPremium = Math.pow(1 + 0.02, 1/4) - 1;
  const qR_p3 = qR.map(r => r + qPremium);

  let p2 = params.p2Start;
  let p3 = params.p3Start;
  let p1 = params.baseSpend;

  let p1Needs = false;
  const p1ReplYears = [];
  const p2ReplYears = [];
  let totalP1Interest = 0;

  const p2SOY_byYear = [];
  let p2Min = p2, minP2IdxYear = 0;

  const mRate = params.p1HysaOn ? (Math.pow(1 + params.p1HysaAPR, 1/12) - 1) : 0;

  for (let y=0; y<HORIZON_YEARS; y++) {
    const year = START_FUTURE + y;
    const qStartIdx = y*4;
    p2SOY_byYear.push(p2);
    if (p2 < p2Min) { p2Min = p2; minP2IdxYear = y; }

    if (params.p3ContribOn && (y+1) <= params.p3ContribYears) p3 += params.p3ContribAmt;

    const S = annualSpend(y+1, params.baseSpend, params.infl, params.cap, params.startIdx);
    const wQ = params.p1Quarter;
    const idxWithdrawQ = qStartIdx + (wQ-1);

    if (mRate > 0) {
      const monthsBefore = 3*(wQ-1);
      if (monthsBefore > 0) {
        const before = p1;
        p1 *= Math.pow(1 + mRate, monthsBefore);
        totalP1Interest += (p1 - before);
      }
    }

    for (let q=0; q<4; q++) {
      const qi = qStartIdx + q;
      p3 *= (1 + qR_p3[qi]);
      p2 *= (1 + qR[qi]);

      if (S > 0 && qi === idxWithdrawQ) {
        const t4q = trailing4QReturn(qR, qi);
        const isNeg = (t4q < 0);

        if (!isNeg && p1Needs && p1 < S) {
          const top = Math.min(S - p1, p2);
          if (top > 0) { p2 -= top; p1 += top; p1ReplYears.push(year); }
          p1Needs = (p1 < S);
        }

        let needed = S;
        if (isNeg) {
          const useP1 = Math.min(needed, p1); p1 -= useP1; needed -= useP1;
          if (needed > 0) { const t = Math.min(needed, p2); p2 -= t; needed -= t; }
          if (needed > 0) { const t = Math.min(needed, p3); p3 -= t; needed -= t; }
          if (p1 < S) p1Needs = true;
        } else {
          const useP2 = Math.min(needed, p2); p2 -= useP2; needed -= useP2;
          if (needed > 0 && p1 > 0) { const t = Math.min(needed, p1); p1 -= t; needed -= t; p1Needs = true; }
          if (needed > 0) { const t = Math.min(needed, p3); p3 -= t; needed -= t; }
        }
      }
    }

    if (mRate > 0) {
      const monthsAfter = 12 - 3*(wQ-1);
      if (monthsAfter > 0) {
        const before2 = p1;
        p1 *= Math.pow(1 + mRate, monthsAfter);
        totalP1Interest += (p1 - before2);
      }
    }

    if (params.lumpsOn && year >= params.lumpStart && ((year - params.lumpStart) % params.lumpEvery === 0)) {
      if (p2 >= params.lumpAmt) {
        p2 -= params.lumpAmt;
      } else {
        let rem = params.lumpAmt - p2; p2 = 0.0;
        const take = Math.min(rem, p3); p3 -= take; rem -= take;
      }
    }

    if (p2 <= 0) {
      const need = params.p2Start - p2;
      const xfer = Math.min(need, p3);
      if (xfer > 0) { p3 -= xfer; p2 += xfer; p2ReplYears.push(year); }
    }
  }

  return {
    summary: {
      window: startYear + "-" + (startYear + HORIZON_YEARS - 1),
      P2_End: p2,
      P3_End: p3,
      P1_Repl_Count: p1ReplYears.length,
      P2_Repl_Count: p2ReplYears.length,
      P2_Min: p2Min,
      P2_Min_Year: (START_FUTURE + minP2IdxYear),
      P1_Interest_Total: totalP1Interest
    },
    trace: { Year: YEARS, P2_SOY: p2SOY_byYear }
  };
}

function fmtMoney(x) {
  if (!isFinite(x)) return "—";
  const v = Math.round(x);
  return "$" + v.toLocaleString();
}

function renderMetrics(summaries) {
  const totalP1 = summaries.reduce((a,s)=>a+s.P1_Repl_Count,0);
  const totalP2 = summaries.reduce((a,s)=>a+s.P2_Repl_Count,0);
  const bestP2 = summaries.reduce((a,s)=> s.P2_End>a.P2_End ? s : a, summaries[0]);
  const worstP2 = summaries.reduce((a,s)=> s.P2_End<a.P2_End ? s : a, summaries[0]);
  const bestP3 = summaries.reduce((a,s)=> s.P3_End>a.P3_End ? s : a, summaries[0]);
  const worstP3 = summaries.reduce((a,s)=> s.P3_End<a.P3_End ? s : a, summaries[0]);
  const totalP1Int = summaries.reduce((a,s)=>a+s.P1_Interest_Total,0);

  const rows = [
    ["Total P1 replenishments", totalP1.toLocaleString()],
    ["Total P2 replenishments", totalP2.toLocaleString()],
    ["Total P1 HYSA interest (sum across windows)", fmtMoney(totalP1Int)],
    ["Best terminal P2 (window)", fmtMoney(bestP2.P2_End) + " — " + bestP2.window],
    ["Worst terminal P2 (window)", fmtMoney(worstP2.P2_End) + " — " + worstP2.window],
    ["Best terminal P3 (window)", fmtMoney(bestP3.P3_End) + " — " + bestP3.window],
    ["Worst terminal P3 (window)", fmtMoney(worstP3.P3_End) + " — " + worstP3.window],
  ];

  document.getElementById("metricsTable").innerHTML =
    rows.map(r => "<tr><td class='metric'>" + r[0] + "</td><td>" + r[1] + "</td></tr>").join("");
}

function renderWorst5(summaries, traces) {
  const sorted = summaries.slice().sort((a,b)=>a.P2_End-b.P2_End).slice(0,5);
  const palette = ["#1f77b4","#2ca02c","#ff7f0e","#9467bd","#8c564b"];
  const data = sorted.map((s,i)=> ({
    x: traces[s.window].Year,
    y: traces[s.window].P2_SOY,
    type: "scatter",
    mode: "lines",
    name: s.window,
    line: { width: 3, color: palette[i] }
  }));
  const layout = {
    title: "Worst 5 P2 trajectories",
    xaxis: { title: "Year" },
    yaxis: { title: "P2 Balance ($)" },
    hovermode: "x unified",
    legend: { title: { text: "Rolling Window" } },
    margin: { l: 40, r: 20, t: 50, b: 40 }
  };
  Plotly.newPlot("worst5", data, layout, {responsive: true});
}

function renderSingleWindow(traces, idx) {
  const key = __WINDOW_LABELS__[idx] || "—";
  const tr = traces[key];
  const data = [{ x: tr.Year, y: tr.P2_SOY, type: "scatter", mode: "lines", name: "P2 (SOY) — " + key, line: { width: 3 } }];
  const layout = {
    title: "P2 trajectory — window " + key,
    xaxis: { title: "Year" },
    yaxis: { title: "P2 Balance ($)" },
    hovermode: "x unified",
    margin: { l: 40, r: 20, t: 50, b: 40 }
  };
  Plotly.newPlot("oneWindow", data, layout, {responsive: true});
  document.getElementById("windowIdxLabel").textContent = key.replace("-", "–");
}

function readParams() {
  const p2Start = parseFloat(document.getElementById("p2Start").value);
  const p3Start = parseFloat(document.getElementById("p3Start").value);
  const baseSpend = parseFloat(document.getElementById("baseSpend").value);
  const infl = parseFloat(document.getElementById("infl").value)/100.0;
  const cap = parseFloat(document.getElementById("cap").value);
  const p3ContribOn = document.getElementById("p3ContribOn").checked;
  const p3ContribAmt = parseFloat(document.getElementById("p3ContribAmt").value);
  const p3ContribYears = parseInt(document.getElementById("p3ContribYears").value);
  const lumpsOn = document.getElementById("lumpsOn").checked;
  const lumpAmt = parseFloat(document.getElementById("lumpAmt").value);
  const lumpEvery = parseInt(document.getElementById("lumpEvery").value);
  const lumpStart = parseInt(document.getElementById("lumpStart").value);
  const startIdx = parseInt(document.getElementById("startYear").value);
  const p1Quarter = parseInt(document.getElementById("p1Quarter").value);
  const p1HysaOn = document.getElementById("p1HysaOn").checked;
  const p1HysaAPR = parseFloat(document.getElementById("p1HysaAPR").value)/100.0;
  const qMode = document.getElementById("qMode").checked;
  const useShiller = document.getElementById("useShiller").checked;
  const qCsv = document.getElementById("qCsv").value;
  return {p2Start, p3Start, baseSpend, infl, cap, p3ContribOn, p3ContribAmt, p3ContribYears,
          lumpsOn, lumpAmt, lumpEvery, lumpStart, startIdx, p1Quarter, p1HysaOn, p1HysaAPR,
          qMode, useShiller, qCsv};
}

// localStorage embedding helpers
function saveEmbeddedShiller(text) { try { localStorage.setItem('shillerMonthlyCSV', text); return true; } catch(err) { return false; } }
function loadEmbeddedShiller() { try { return localStorage.getItem('shillerMonthlyCSV'); } catch(err) { return null; } }

// Site CSV autoload
const SITE_CSV_PATH = './shiller_monthly.csv';
async function tryLoadSiteCSV() {
  try {
    const res = await fetch(SITE_CSV_PATH, {cache:'no-store'});
    if (!res.ok) return null;
    const text = await res.text();
    const parsed = parseShillerMonthlyCSV(text);
    if (parsed && parsed.length>0) {
      const e = document.getElementById('embedStatus');
      if (e) e.textContent = 'Loaded site CSV ('+parsed.length+' monthly rows).';
      return parsed;
    }
  } catch(err){}
  return null;
}

function determineWindowStartsFromShiller(ms) {
  const years = ms.map(r=>r.year);
  const minY = Math.min.apply(null, years);
  const maxY = Math.max.apply(null, years);
  const lastStart = maxY - (HORIZON_YEARS - 1);
  const arr = [];
  for (let y=minY; y<=lastStart; y++) arr.push(y);
  return arr;
}

function monthsAvailableForWindow(ms, startYear) {
  for (let y=0; y<HORIZON_YEARS; y++) {
    const yr = startYear + y;
    for (const m of [1,2,3,4,5,6,7,8,9,10,11,12]) {
      if (!ms.find(o=>o.year===yr && o.month===m)) return false;
    }
  }
  return true;
}

function buildQuarterliesForAll(ms, useQuarterlyFallbackIfAnnual=false) {
  const starts = determineWindowStartsFromShiller(ms);
  const validStarts = starts.filter(s => monthsAvailableForWindow(ms, s));
  const label = s => s + "-" + (s + HORIZON_YEARS - 1);
  const qMap = {}; // startYear -> quarterly array
  for (const s of validStarts) {
    const qs = monthsToQuarterlies(ms, s);
    if (qs) qMap[s] = qs;
  }
  return {starts: validStarts, labels: validStarts.map(label), qMap};
}

function buildAnnualFallbackStarts() {
  const years = Object.keys(SP500_ANNUAL).map(k=>parseInt(k)).sort((a,b)=>a-b);
  if (years.length===0) return {starts:[], labels:[]};
  const minY = years[0];
  const maxY = years[years.length-1];
  const lastStart = maxY - (HORIZON_YEARS - 1);
  const starts = [];
  for (let y=minY; y<=lastStart; y++) starts.push(y);
  const labels = starts.map(s => s + "-" + (s + HORIZON_YEARS - 1));
  return {starts, labels};
}

function renderSingleWindowInit() {
  const idxEl = document.getElementById("windowIdx");
  idxEl.min = 0;
  idxEl.max = Math.max(0, __WINDOW_LABELS__.length-1);
  idxEl.value = 0;
  const lab = __WINDOW_LABELS__.length ? __WINDOW_LABELS__[0] : "—";
  document.getElementById("windowIdxLabel").textContent = lab.replace("-", "–");
}

function renderWorst5OrEmpty(summaries, traces) {
  if (!summaries.length) {
    document.getElementById("worst5").innerHTML = "<div class='small'>No windows available in the selected data.</div>";
    document.getElementById("oneWindow").innerHTML = "";
    document.getElementById("metricsTable").innerHTML = "";
    return;
  }
  renderMetrics(summaries);
  renderWorst5(summaries, traces);
  renderSingleWindow(traces, 0);
  renderSingleWindowInit();
}

document.getElementById('embedShillerBtn').addEventListener('click', ()=>{
  const fileInput = document.getElementById('shillerFile');
  const ta = document.getElementById('shillerPaste');
  const done = (text)=>{
    if (!text || !text.trim()) { document.getElementById('embedStatus').textContent = 'No CSV provided.'; return; }
    const parsed = parseShillerMonthlyCSV(text);
    if (!parsed || parsed.length===0) { document.getElementById('embedStatus').textContent = 'Could not parse CSV.'; return; }
    if (!saveEmbeddedShiller(text)) { document.getElementById('embedStatus').textContent = 'Could not store data (localStorage?).'; return; }
    __SHILLER_MONTHS__ = parsed;
    document.getElementById('useShiller').checked = true;
    document.getElementById('embedStatus').textContent = 'Embedded '+parsed.length+' rows. It will auto-load next time.';
  };
  if (fileInput.files && fileInput.files[0]) {
    const reader = new FileReader();
    reader.onload = ()=> done(reader.result);
    reader.readAsText(fileInput.files[0]);
  } else {
    done(ta.value);
  }
});

async function simulate() {
  const btn = document.getElementById("simulateBtn");
  btn.disabled = true;
  btn.textContent = "Simulating…";
  try {
    const p = readParams();

    let shiller = __SHILLER_MONTHS__;
    if (!shiller) {
      // Try to autoload site CSV first
      shiller = await tryLoadSiteCSV();
      if (!shiller) {
        // Then embedded LS
        const txt = loadEmbeddedShiller();
        if (txt) {
          const parsed = parseShillerMonthlyCSV(txt);
          if (parsed && parsed.length>0) {
            document.getElementById('embedStatus').textContent = 'Loaded embedded Shiller monthly ('+parsed.length+' rows).';
            shiller = parsed;
          }
        }
      }
    }

    let summaries = [];
    let traces = {};

    if (p.qMode && p.useShiller && shiller && shiller.length>0) {
      const qdata = buildQuarterliesForAll(shiller);
      WINDOW_STARTS = qdata.starts;
      __WINDOW_LABELS__ = qdata.labels;
      if (WINDOW_STARTS.length===0) {
        document.getElementById("metricsTable").innerHTML = "<tr><td>No full 40-year windows in the CSV</td></tr>";
      }
      for (const s of WINDOW_STARTS) {
        const res = simulateWindowQuarterly(s, p, qdata.qMap[s]);
        if (res) {
          summaries.push(res.summary);
          traces[res.summary.window] = res.trace;
        }
      }
    } else {
      // No Shiller, use annual fallback windows (post-1935-ish)
      const af = buildAnnualFallbackStarts();
      WINDOW_STARTS = af.starts;
      __WINDOW_LABELS__ = af.labels;
      for (const s of WINDOW_STARTS) {
        const res = simulateWindowQuarterly(s, p, null);
        if (res) {
          summaries.push(res.summary);
          traces[res.summary.window] = res.trace;
        }
      }
    }

    // Render
    renderWorst5OrEmpty(summaries, traces);
  } finally {
    btn.disabled = false;
    btn.textContent = "Simulate";
  }
}

document.addEventListener("DOMContentLoaded", ()=> {
  ["p2Start","p3Start","baseSpend","startYear","infl","cap","p3ContribOn","p3ContribAmt","p3ContribYears","lumpsOn","lumpAmt","lumpEvery","lumpStart","windowIdx","p1Quarter","p1HysaOn","p1HysaAPR","qMode","useShiller","qCsv"].forEach(id=> {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener("input", ()=>{});
    el.addEventListener("change", ()=>{});
  });
  document.getElementById("simulateBtn").addEventListener("click", simulate);

  // Tabs
  const tabDash = document.getElementById("tabDash");
  const tabAbout = document.getElementById("tabAbout");
  const panelDash = document.getElementById("panelDash");
  const panelAbout = document.getElementById("panelAbout");
  function activate(tab) {
    if (tab === "dash") {
      tabDash.classList.add("active"); tabAbout.classList.remove("active");
      panelDash.style.display = ""; panelAbout.style.display = "none";
    } else {
      tabAbout.classList.add("active"); tabDash.classList.remove("active");
      panelAbout.style.display = ""; panelDash.style.display = "none";
    }
  }
  tabDash.addEventListener("click", ()=>activate("dash"));
  tabAbout.addEventListener("click", ()=>activate("about"));
});
</script>

</body></html>
